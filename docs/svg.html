<html lang="en">
<head>
<meta charset="utf-8">
<title>SVG</title>
<script src="https://cjrtnc.leaningtech.com/2.3/loader.js"></script>
</head>
<style>
.container {
	display: flex;
	justify-content: center;
	width: 100%;
	height: 80%;
}

.cell {
	width: 50%;
	margin: 2px;
}

#popup {
	background-color: #EEE;
	padding: 10px;
	position: absolute;
	top: 0px;
	right: 0px;
	visibility: hidden;
}

#uml {
	width: 100%;
	height: 100%;
}
</style>

<body>
	<div id=popup>ERROR</div>
	<div id=debugjava>(...init in progress...)</div>

	<div class=container>
		<div class=cell>
			<textarea spellcheck=false id=uml oninput="done()">
@startuml
Alice -> Bob : Hello!
@enduml
</textarea>
		</div>

		<div class=cell id=colb></div>



	</div>
	<!--container-->

	<script>
var _inprogress = false;
var version_input = 0;
var version_displayed = 0;

function done() {
	text = document.getElementById('uml').value;
	version_input++;
	const current = version_input;
	if (_inprogress) return;
	_inprogress = true;
	cjCall("com.plantuml.api.cheerpj.v1.Svg", "convert", "light", text).then((res) => {
		if (res.startsWith("<")) {
			document.getElementById("popup").style.visibility = "hidden";
			if (current==version_input)
			document.getElementById('colb').innerHTML=res;
		} else {
			document.getElementById('popup').innerText=res;
			document.getElementById("popup").style.visibility = "visible";
		}
		version_displayed = current;
		_inprogress = false;
		if (current<version_input) done();
	});
}

var url = window.location.href;
var x = url.lastIndexOf("?");
if (x>0)
	document.getElementById('uml').value = "...in progress...";

cheerpjInit({disableLoadTimeReporting:true,disableErrorReporting:true}).then( (val0) => {
	cheerpjRunMain("com.plantuml.api.cheerpj.v1.RunInit", "/app/plantuml-core/plantuml-core.jar", "/app/", "debugjava").then ( (val1) => {
		if (x>0) {
			var encoded = url.substr(x+1);
			console.log(encoded);
			cjCall("com.plantuml.api.cheerpj.v1.Info", "decode", encoded).then((res) => {
				document.getElementById('uml').value = res;
				done();
			});
			
		} else		
			done();
	});
});
  </script>

</body>


</html>
